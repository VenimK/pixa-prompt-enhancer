name: Build, Test, and Package

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  release:
    types: [created]

jobs:
  build:
    name: Build and Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.10']  # Use a single, well-supported version for builds
        include:
          - os: ubuntu-latest
            artifact_name: prompt-enhancer-linux
          - os: windows-latest
            artifact_name: prompt-enhancer-windows
          - os: macos-latest
            artifact_name: prompt-enhancer-macos
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'  # Using LTS version
        cache: 'npm'
    
    - name: Install system dependencies (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-venv
    
    - name: Set up Python environment
      shell: bash
      run: |
        python -m venv venv
        if [[ "${{ runner.os }}" == "Windows" ]]; then
          source venv/Scripts/activate
        else
          source venv/bin/activate
        fi
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Install Node.js dependencies
      shell: bash
      run: |
        # Use npm ci for clean install
        if [ -f "package-lock.json" ]; then
          npm ci
        else
          npm install
        fi
    
    - name: Run Python tests
      shell: bash
      run: |
        source venv/bin/activate
        python -m pytest tests/ || echo "No tests found or tests failed"
    
    - name: Lint Python code
      shell: bash
      run: |
        source venv/bin/activate
        pip install black flake8
        black --check .
        flake8 .
    
    - name: Lint JavaScript code
      run: npx eslint "**/*.js"
    
    - name: Verify application starts
      env:
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
      shell: bash
      run: |
        source venv/bin/activate
        # Start the server in the background
        nohup uvicorn app.main:app --port 8000 --host 0.0.0.0 > server.log 2>&1 &
        SERVER_PID=$!
        
        # Give the server some time to start
        sleep 5
        
        # Check if the server is running
        if curl --output /dev/null --silent --head --fail http://localhost:8000; then
          echo "✅ Server started successfully"
          # Kill the server
          kill $SERVER_PID
        else
          echo "❌ Server failed to start"
          cat server.log
          exit 1
        fi
    
    - name: Create package for distribution (Linux/macOS)
      if: matrix.os != 'windows-latest'
      shell: bash
      run: |
        mkdir -p dist/${{ matrix.artifact_name }}
        
        # Copy necessary files
        cp -r app dist/${{ matrix.artifact_name }}/
        cp -r static dist/${{ matrix.artifact_name }}/
        cp requirements.txt dist/${{ matrix.artifact_name }}/
        cp README.md dist/${{ matrix.artifact_name }}/
        
        # Create a run script for Linux/macOS
        echo '#!/bin/bash' > dist/${{ matrix.artifact_name }}/run.sh
        echo 'python3 -m venv venv' >> dist/${{ matrix.artifact_name }}/run.sh
        echo 'source venv/bin/activate' >> dist/${{ matrix.artifact_name }}/run.sh
        echo 'pip install -r requirements.txt' >> dist/${{ matrix.artifact_name }}/run.sh
        echo 'uvicorn app.main:app --host 0.0.0.0 --port 8000' >> dist/${{ matrix.artifact_name }}/run.sh
        chmod +x dist/${{ matrix.artifact_name }}/run.sh
        
        # Create archive
        cd dist
        tar -czf ${{ matrix.artifact_name }}.tar.gz ${{ matrix.artifact_name }}
        cd ..
    
    - name: Create package for distribution (Windows)
      if: matrix.os == 'windows-latest'
      shell: pwsh
      run: |
        $artifactDir = "dist\${{ matrix.artifact_name }}"
        New-Item -ItemType Directory -Force -Path $artifactDir | Out-Null
        
        # Copy necessary files
        Copy-Item -Path "app" -Destination $artifactDir -Recurse -Force
        Copy-Item -Path "static" -Destination $artifactDir -Recurse -Force
        Copy-Item -Path "requirements.txt" -Destination $artifactDir -Force
        Copy-Item -Path "README.md" -Destination $artifactDir -Force
        
        # Create a run script for Windows
        @'
        @echo off
        python -m venv venv
        call venv\Scripts\activate.bat
        pip install -r requirements.txt
        uvicorn app.main:app --host 0.0.0.0 --port 8000
        '@ | Out-File -FilePath "$artifactDir\run.bat" -Encoding ascii
        
        # Create zip archive
        Compress-Archive -Path "dist\${{ matrix.artifact_name }}" -DestinationPath "dist\${{ matrix.artifact_name }}.zip" -Force
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: dist/${{ matrix.artifact_name }}*.*
        retention-days: 1

  release:
    name: Create Release
    needs: build
    if: github.event_name == 'release' && github.event.action == 'created'
    runs-on: ubuntu-latest
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/prompt-enhancer-linux/*
            artifacts/prompt-enhancer-macos/*
            artifacts/prompt-enhancer-windows/*
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}